<?php 
/**
 * Plugin Name: Bill Upload in Order 
 * Description: This plugin  Bill Upload in Order
 * Author: Yash Pal
 * Version: 1.0
 * License: Free
 **/
add_action( 'add_meta_boxes', 's_add_meta_boxes' );
if ( ! function_exists( 's_add_meta_boxes' ) )
{
    function s_add_meta_boxes()
    {
        add_meta_box( 'mv_other_fields', __('Bill Upload','woocommerce'), 's_add_other_fields_for_packaging', 'shop_order', 'side', 'core' );
    }
}

// Adding Meta field in the meta container admin shop_order pages
if ( ! function_exists( 's_add_other_fields_for_packaging' ) )
{
    function s_add_other_fields_for_packaging()
    {
        global $post;

        $meta_field_data = get_post_meta( $post->ID, '_s_bill_upload_slug', true ) ? get_post_meta( $post->ID, '_s_bill_upload_slug', true ) : '';

        echo '<input type="hidden" name="s_other_meta_field_nonce" value="' . wp_create_nonce() . '">
        <p style="border-bottom:solid 1px #eee;padding-bottom:13px;">
            <input type="file"  style="width:250px;";" name="billUploadName" >
			<img src="' . $meta_field_data . '">
			
			</p>';

    }
}

// Save the data of the Meta field
add_action( 'save_post', 'mv_save_wc_order_other_fields', 10, 1 );
if ( ! function_exists( 'mv_save_wc_order_other_fields' ) )
{

    function mv_save_wc_order_other_fields( $post_id ) {
		
		
		$path=wp_get_upload_dir();
        $upload_dir=$path['baseurl'].'/billuploaded';
		/*if (! is_dir($upload_dir)) {
           mkdir($upload_dir,700);
		   die("kk");
		}*/


        // We need to verify this with the proper authorization (security stuff).

        // Check if our nonce is set.
        if ( ! isset( $_POST[ 's_other_meta_field_nonce' ] ) ) {
            return $post_id;
        }
        $nonce = $_REQUEST[ 's_other_meta_field_nonce' ];

        //Verify that the nonce is valid.
        if ( ! wp_verify_nonce( $nonce ) ) {
            return $post_id;
        }

        // If this is an autosave, our form has not been submitted, so we don't want to do anything.
        if ( defined( 'DOING_AUTOSAVE' ) && DOING_AUTOSAVE ) {
            return $post_id;
        }

        // Check the user's permissions.
        if ( 'page' == $_POST[ 'post_type' ] ) {

            if ( ! current_user_can( 'edit_page', $post_id ) ) {
                return $post_id;
            }
        } else {

            if ( ! current_user_can( 'edit_post', $post_id ) ) {
                return $post_id;
            }
        }
		print_r($_FILES);
        echo $ImageName = $_FILES['billUploadName']['name'];
		echo $location = $upload_dir . $_FILES['billUploadName']['name']; 
		if(move_uploaded_file($_FILES['billUploadName']['tmp_name'], $location)){
		echo "kjkjk";
		}		
		die;
        update_post_meta( $post_id, '_s_bill_upload_slug', $_POST[ 'billUploadName' ] );
    }
}

add_action( 'rest_api_init', 'rest_api_meta_update_filters' );

 /**
  * Add the necessary filter to each post type
  **/
function rest_api_meta_update_filters() {
	foreach ( get_post_types( array( 'show_in_rest' => true ), 'objects' ) as $post_type ) {
		
		
 add_action( 'woocommerce_rest_pre_insert_shop_order_object','maybe_set_item_meta_datan',10, 2);  
	}
}

/**
 * Add the filter parameter
 *
 * @param  array           $args    The query arguments.
 * @param  WP_REST_Request $request Full details about the request.
 * @return array $args.
 **/
 function maybe_set_item_meta_datan( $item, $posted ) {	 
	$image=$_FILES['bill_receipt']['name'];
	$tmppath=$_FILES['bill_receipt']['tmp_name'];
	$uploadir= wp_upload_dir();
	$ext = pathinfo($image, PATHINFO_EXTENSION);
	$filename = pathinfo($image, PATHINFO_FILENAME );


 $newfile = str_replace(' ', '',$filename.time().'.'.$ext); 
 $newfile = str_replace(' ', '',$filename.time().'.'.$ext);
// $filename  = $uploadir['basedir']."/billuploaded/".$newfile;

  /* $uploads_dir = trailingslashit( plugin_dir_path( dirname( __FILE__ ) ) ) . 'images';
               wp_mkdir_p( $uploads_dir ); 
   $UploadDirectory =trailingslashit(WP_CONTENT_DIR.'/uploads/billuploaded/');
 $destination = trailingslashit( $uploads_dir ) . $_FILES['bill_receipt']['name']; */
 
 
 
 if ( ! function_exists( 'wp_handle_upload' ) ) {
    require_once( ABSPATH . 'wp-admin/includes/file.php' );
}

$uploadedfile = $_FILES['bill_receipt'];

$upload_overrides = array( 'test_form' => false );

$movefile = wp_handle_upload( $uploadedfile, $upload_overrides );

if ( $movefile && ! isset( $movefile['error'] ) ) {
	$item->update_meta_data('_bill_upload_slug', $newfile,$posted);	   
		return $item;
    //echo "File is valid, and was successfully uploaded.\n";
    //var_dump( $movefile );
} else {
    /**
     * Error generated by _wp_handle_upload()
     * @see _wp_handle_upload() in wp-admin/includes/file.php
     */
    echo $movefile['error'];
	
}


 
 
 
 
 
 
 
 
 
if(!file_exists($newfile)){ 



 /* if($dt=wp_upload_bits($_FILES['bill_receipt']['name'], 'NULL',$_FILES['bill_receipt']['tmp_name'])){
	print_r($dt);
	die($dt);
}; 
       die;  */        

     /*if(move_uploaded_file($tmppath,$destination)){
		echo "dsdsg";
		die;
		$item->update_meta_data('_bill_upload_slug', $newfile,$posted);	   
		//return $item;
    } */
}

//die;
		
 }
 function upadtemeta($args, $request ) { 
 //print_r($request[]);
$image=$_FILES['bill_receipt']['name'];
$tmppath=$_FILES['bill_receipt']['tmp_name'];
$uploadir= wp_get_upload_dir();
$uploadirr= wp_upload_dir();
//echo $ext = pathinfo($image, PATHINFO_EXTENSION);
 //$filename = pathinfo($tmppath, PATHINFO_FILENAME );
//print_r($uploadirr);
//print_r($path['baseurl']);
  $path = $uploadirr['basedir']."/billuploaded/".$image;
//echo  $name = basename($_FILES["bill_receipt"]["name"]);
///echo $post_id;
//print_r($request);die;

if(move_uploaded_file($tmppath,$path)){
	echo $item_id;
wc_update_order_item_meta( $item_id, '_bill_upload_slug', $image );
 ///update_post_meta( $post_id, '_bill_upload_slug', '$image');
 echo "hggk";
 die;
 
 /* if ( isset( $request['bill_receipt'] ) ) {
			if ( ! empty( $args['meta_query'] ) ) {
				$args['meta_query'] = array();
			}

			$args['meta_query'][] = array(
				'key'   => '_s_bill_upload_slug',
				'value' => $image,
				'type'  => 'NUMERIC',
			);
		}  */   
    
}else
{
echo 'not uploaded'; 
 
}
//die;
return $args; 
}; 

?>